# Telegram Build Bot — initial implementation

This repository contains an MVP Telegram bot for collecting free-text construction progress reports from foremen and writing them to Google Sheets.

## Quick start
1. Copy `.env.example` to `.env` and fill values.
2. Place your Google service account JSON at the path specified in `.env`.
3. Provide a `whitelist.json` file with structure: `{"ids": [123456789], "usernames": ["proраб"]}`
4. Build and run:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python bot/main.py
```

## Docker
Build image:
```
docker build -t telegram-build-bot:latest .
```
Run container (mount secrets):
```
docker run -v /path/to/google.json:/secrets/google-service-account.json -v /path/to/whitelist.json:/data/whitelist.json telegram-build-bot:latest
```

# Notes
- This is an MVP. Webhook mode, advanced admin commands, and robust monitoring are planned in next iterations.


# **Техническая спецификация: Telegram-бот для сбора строительных данных**

## **1. Область применения и цели**

Система предназначена для автоматизации ежедневного сбора данных о выполненных объёмах строительных работ от подрядчиков.
Бот принимает сообщения в свободной форме, обрабатывает их с помощью локальной модели машинного обучения (LLM), структурирует информацию и записывает результаты в Google Sheets, соответствующую графику производства работ.

**Цели проекта:**

* Упростить процесс предоставления отчётности подрядчиками;
* Повысить точность и актуальность данных о ходе строительства;
* Обеспечить оперативную аналитику для руководства компании;
* Создать основу для последующего внедрения цифрового двойника строительного проекта.

---

## **2. Функциональные требования**

1. **Обмен сообщениями:**

   * Бот принимает текстовые сообщения от пользователей в Telegram.
   * Бот поддерживает режимы `polling` и `webhook`.
   * В ответ на сообщение бот возвращает подтверждение о приёме данных.

2. **Авторизация пользователей:**

   * Проверка доступа через whitelist (ID и username).
   * Возможность обновления whitelist без перезапуска бота.
   * Администраторы определяются в `.env` через `ADMIN_IDS`.

3. **Обработка данных:**

   * Текст сообщений анализируется локальной моделью (LLM).
   * Извлекаются структурированные поля: проект, этап, дата, объём, комментарий.
   * Результаты записываются в таблицу Google Sheets.

4. **Работа с Google Sheets:**

   * Подключение через сервисный аккаунт.
   * Запись данных в заданный диапазон по `SPREADSHEET_ID`.
   * Проверка корректности структуры таблицы при запуске.

5. **Управление конфигурацией:**

   * Все настройки загружаются из `.env`.
   * Поддержка разных окружений (например, тестового и продуктивного).

---

## **3. Нефункциональные требования**

* **Производительность:** бот должен обрабатывать сообщение и записывать данные в Google Sheets не более чем за 3 секунды при стабильном соединении.
* **Надёжность:** устойчивость к временным сбоям API и сетевым ошибкам.
* **Масштабируемость:** возможность добавления новых проектов и таблиц без изменения архитектуры.
* **Поддерживаемость:** структура кода модульная, легко расширяемая.
* **Логирование:** все действия фиксируются с уровнем INFO или выше.
* **Совместимость:** код совместим с Python 3.11+.

---

## **4. Платформы, ограничения и предположения**

* **Среда выполнения:** Python 3.11+.
* **Инфраструктура:** Docker-контейнер или bare-metal сервер Linux.
* **Ограничения Telegram:** максимальная длина сообщений 4096 символов.
* **Хранение данных:** все данные (whitelist, .env, кэш) хранятся локально.
* **Предположения:** пользователи имеют стабильный доступ к Telegram и идентифицируются по username и ID.

---

## **5. Предпочтительные технологии и архитектурные решения**

| Компонент               | Технология / библиотека              |
| ----------------------- | ------------------------------------ |
| Язык                    | Python 3.11+                         |
| Telegram API            | aiogram                              |
| Google Sheets           | gspread, google-auth                 |
| Конфигурация            | python-dotenv                        |
| Авторизация             | JSON whitelist                       |
| Логирование             | loguru                               |
| Машинное обучение (LLM) | локальная модель через API-интерфейс |
| Контейнеризация         | Docker                               |
| Тестирование            | pytest                               |

**Архитектура:** модульная, слои:

* `bot` — взаимодействие с Telegram API;
* `auth` — контроль доступа;
* `parser` — обработка сообщений и извлечение данных;
* `google_service` — запись и чтение таблиц;
* `config` — централизованная конфигурация;
* `main` — инициализация и запуск приложения.

---

## **6. Безопасность и контроль доступа**

* Используются **сервисные ключи Google** (JSON) с ограниченными правами.
* Все пути и токены хранятся только в `.env`, без коммита в репозиторий.
* `ADMIN_IDS` определяет список пользователей, имеющих право управлять ботом.
* Файл `whitelist.json` используется для допуска исполнителей.
* Для каждого сообщения проводится авторизационная проверка:

  ```python
  if not auth.is_allowed(user_id, username):
      logger.info(f"Unauthorized message from {user_id} / {username}")
      return
  ```

---

## **7. Модель данных и схема Google-таблицы**

**Формат таблицы Google Sheets:**

| Проект   | Этап    | Дата       | Объём | Комментарий     | Отправитель |
| -------- | ------- | ---------- | ----- | --------------- | ----------- |
| ЖК Север | Монолит | 2025-10-25 | 45 м³ | Залита 1 секция | kolobook146 |

**Типы данных:**

* `Проект` — строка (название);
* `Этап` — строка (тип работ);
* `Дата` — дата (формат YYYY-MM-DD);
* `Объём` — число (м³, м², тн);
* `Комментарий` — строка (опционально);
* `Отправитель` — Telegram username.

---

## **8. API-интеграции и внешние сервисы**

* **Telegram API:** взаимодействие через библиотеку `aiogram`.
* **Google Sheets API:** доступ через `google-auth` и `gspread`.
* **LLM API (локальный):** интерфейс для анализа текста и извлечения данных.
* **Дополнительно:** поддержка будущих интеграций с Power BI через выгрузку таблиц.

---

## **9. Тестирование и критерии приёмки**

**Типы тестов:**

* Unit-тесты: проверка авторизации, конфигурации и парсера.
* Интеграционные: запись данных в тестовую Google-таблицу.
* Smoke-тесты: проверка запуска бота и подключения к Telegram API.

**Критерии приёмки:**

* Авторизованный пользователь успешно отправляет сообщение и получает подтверждение.
* Данные корректно записываются в Google Sheets.
* Неавторизованный пользователь получает уведомление об отказе в доступе.
* Ошибки логируются без падения процесса.

---

## **10. Риски и меры по их уменьшению**

| Риск                           | Меры по снижению                                                     |
| ------------------------------ | -------------------------------------------------------------------- |
| Сбой Telegram API              | Автоматический перезапуск через Supervisor или Docker Restart Policy |
| Потеря соединения с Google API | Повторные попытки с экспоненциальной задержкой                       |
| Повреждение whitelist.json     | Резервная копия при каждом обновлении                                |
| Неверные данные от подрядчика  | Валидация формата и предупреждения пользователю                      |
| Изменение структуры таблицы    | Автоматическая проверка схемы при запуске                            |

---

## **11. Документы и артефакты поставки**

**В комплект поставки входят:**

* Исходный код проекта (структурированный по модулям);
* Файл `.env.example` с шаблоном конфигурации;
* `Dockerfile` и `docker-compose.yml`;
* Инструкции по развёртыванию;
* Тестовый файл `whitelist.json`;
* Образец Google Sheet с преднастроенной структурой;
* Документация разработчика и администратора;
* Журнал изменений (CHANGELOG.md).